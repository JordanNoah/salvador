{"version":3,"file":"modals.min.js","sources":["../../src/resources/modals.js"],"sourcesContent":["import {\r\n    autocompleteThemes\r\n} from \"local_digitalta/themes/autocomplete\";\r\nimport {\r\n    autocompleteTags\r\n} from \"local_digitalta/tags/autocomplete\";\r\nimport {\r\n    createTinyMCE,\r\n    getTinyMCEContent\r\n} from \"local_digitalta/tiny/manage\";\r\nimport {\r\n    displayLinkResourceModal,\r\n    displayLinkResourcesModal\r\n} from \"local_digitalta/experiences/modals\";\r\nimport {\r\n    experiencesGet\r\n} from \"local_digitalta/repositories/experiences_repository\";\r\nimport {\r\n    getList\r\n} from \"core/normalise\";\r\nimport {\r\n    languagesGet\r\n} from \"local_digitalta/repositories/languages_repository\";\r\nimport {\r\n    resourcesGet,\r\n    resourcesUpsert,\r\n    resourcesTypesGet\r\n} from \"local_digitalta/repositories/resources_repository\";\r\nimport Modal from 'core/modal';\r\nimport ModalEvents from \"core/modal_events\";\r\nimport ModalFactory from \"core/modal_factory\";\r\nimport ModalRegistry from 'core/modal_registry';\r\nimport Notification from \"core/notification\";\r\n\r\nconst manageResourcesModal = class extends Modal {\r\n    static TYPE = 'local_digitalta/manageResourcesModal';\r\n    static TEMPLATE = 'local_digitalta/resources/modals/modal-manage';\r\n    registerEventListeners() {\r\n        super.registerEventListeners();\r\n        this.registerCloseOnSave();\r\n        this.registerCloseOnCancel();\r\n    }\r\n};\r\nModalRegistry.register(manageResourcesModal.TYPE, manageResourcesModal, manageResourcesModal.TEMPLATE);\r\n\r\n/**\r\n * Show the add resources modal.\r\n *\r\n * @param {Number} resourceid\r\n * @param {Number} experienceid\r\n */\r\nexport const showManageResourcesModal = async (resourceid = null, experienceid = null) => {\r\n    // Types\r\n    const types = await resourcesTypesGet().then((response) => { return response.types; });\r\n    // Languages\r\n    const languages = await languagesGet({prioritizeInstalled: true});\r\n    // Resource\r\n    const resource = resourceid === null\r\n        ? {}\r\n        : await resourcesGet({id: resourceid}).then((response) => { return response.resources[0]; });\r\n    // Experience\r\n    const experience = experienceid === null\r\n        ? Promise.resolve({})\r\n        : await experiencesGet(experienceid).then((response) => response.experience);\r\n    Promise.all([languages, resource, experience])\r\n        .then(([languages, resource, experience]) =>\r\n            displayManageResourcesModal(types, languages, resource, experience));\r\n};\r\n\r\n/**\r\n * Display the add resource modal.\r\n *\r\n * @param {Array} types\r\n * @param {Array} languages\r\n * @param {Object} resource\r\n * @param {Object} experience\r\n */\r\nexport const displayManageResourcesModal = async (types, languages, resource = {}, experience = {}) => {\r\n    // Languages\r\n    let anyLanguageSelected = false;\r\n    languages = languages.map((language) => {\r\n        language.selected = false;\r\n        if (resource.hasOwnProperty('lang') && language.code === resource.lang) {\r\n            language.selected = anyLanguageSelected = true;\r\n        }\r\n        return {\r\n            key: language.code,\r\n            value: language.name,\r\n            selected: language.selected\r\n        };\r\n    });\r\n    if (!anyLanguageSelected) {\r\n        languages[0].selected = true;\r\n    }\r\n    languages[0].selected = true;\r\n    // Types\r\n    let anyTypeSelected = false;\r\n    types = types.map((type) => {\r\n        type.selected = false;\r\n        if (resource.hasOwnProperty('type') && type.id === resource.type) {\r\n            type.selected = anyTypeSelected = true;\r\n        }\r\n        return {\r\n            key: type.id,\r\n            value: type.name,\r\n            selected: type.selected\r\n        };\r\n    });\r\n    if (!anyTypeSelected) {\r\n        types[0].selected = true;\r\n    }\r\n    const modal = await ModalFactory.create({\r\n        type: manageResourcesModal.TYPE,\r\n        templateContext: {\r\n            experienceid: experience.id,\r\n            languages: languages,\r\n            types: types,\r\n            current: {\r\n                id: resource.id ?? 0,\r\n                name: resource.name ?? null,\r\n                path: resource.path ?? null,\r\n                description: resource.description ?? null,\r\n                themes: resource.themes ?? [],\r\n                tags: resource.tags ?? [],\r\n                type: resource.type ?? null,\r\n                format: resource.format ?? 'Link'\r\n            }\r\n        },\r\n        large: true,\r\n        removeOnClose: true\r\n    });\r\n    modal.show();\r\n    const $root = modal.getRoot();\r\n    createTinyMCE('resource-manage-description');\r\n    autocompleteTags('#resource-manage-tags');\r\n    autocompleteThemes('#resource-manage-themes');\r\n    if (experience) {\r\n        const changeElement = $root.find(\"#changeToImportResource\").get(0);\r\n        if (changeElement) {\r\n            changeElement.onclick = () => {\r\n                displayLinkResourcesModal(true);\r\n                modal.destroy();\r\n            };\r\n        }\r\n    }\r\n    $root.on(ModalEvents.save, (event, modal) => {\r\n        event.preventDefault();\r\n        const form = $root[0].querySelector('form');\r\n        if (validateManageRequiredFields(form)) {\r\n            handleManageResourcesModalSubmission(event, modal);\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Handle the submission of the dialogue.\r\n *\r\n * @param {Event} event\r\n * @param {Modal} modal\r\n */\r\nconst handleManageResourcesModalSubmission = async (event, modal) => {\r\n    const form = getList(modal.getRoot())[0].querySelector(\"form\");\r\n\r\n    if (!form) {\r\n        return;\r\n    }\r\n    const experienceid = form.querySelector('input[name=\"resource-manage-experienceid\"]').value;\r\n    const formData = {\r\n        id: form.querySelector('input[name=\"resource-manage-id\"]').value,\r\n        name: form.querySelector('input[name=\"resource-manage-name\"]').value,\r\n        description: getTinyMCEContent('resource-manage-description'),\r\n        type: form.querySelector('select[name=\"resource-manage-type\"]').value,\r\n        format: form.querySelector('input[name=\"resource-manage-format\"]').value,\r\n        path: form.querySelector('input[name=\"resource-manage-path\"]').value,\r\n        lang: form.querySelector('select[name=\"resource-manage-language\"]').value,\r\n        themes: Array.from(\r\n            form.querySelectorAll('select[name=\"resource-manage-themes\"] option:checked'),\r\n            option => option.value),\r\n        tags: Array.from(\r\n            form.querySelectorAll('select[name=\"resource-manage-tags\"] option:checked'),\r\n            option => option.value)\r\n    };\r\n    try {\r\n        const resourceid = await resourcesUpsert(formData).then((response) => { return response.resourceid; });\r\n        Notification.addNotification({\r\n            message: \"Resource saved successfully.\",\r\n            type: 'success'\r\n        });\r\n        if (experienceid) {\r\n            displayLinkResourceModal(experienceid, resourceid);\r\n            return;\r\n        }\r\n        location.reload();\r\n    } catch (error) {\r\n        Notification.exception(error);\r\n    }\r\n};\r\n\r\n/**\r\n * Validate required fields.\r\n *\r\n * @param {HTMLElement} form The form to validate.\r\n * @return {boolean} True if all required fields are filled.\r\n */\r\nconst validateManageRequiredFields = (form) => {\r\n    const requiredFields = form.querySelectorAll('input[required], select[required], textarea[required]');\r\n    for (const field of requiredFields) {\r\n        if (!field.value) {\r\n            field.focus();\r\n            return false;\r\n        }\r\n    }\r\n    return true;\r\n};\r\n"],"names":["manageResourcesModal","Modal","registerEventListeners","registerCloseOnSave","registerCloseOnCancel","register","TYPE","TEMPLATE","async","resourceid","experienceid","types","then","response","languages","prioritizeInstalled","resource","id","resources","experience","Promise","resolve","all","_ref","displayManageResourcesModal","anyLanguageSelected","map","language","selected","hasOwnProperty","code","lang","key","value","name","anyTypeSelected","type","modal","ModalFactory","create","templateContext","current","path","description","themes","tags","format","large","removeOnClose","show","$root","getRoot","changeElement","find","get","onclick","destroy","on","ModalEvents","save","event","preventDefault","form","querySelector","validateManageRequiredFields","handleManageResourcesModalSubmission","formData","Array","from","querySelectorAll","option","addNotification","message","location","reload","error","exception","requiredFields","field","focus"],"mappings":"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"}